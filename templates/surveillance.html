{% extends "layout.html" %}

{% block title %}Surveillance{% endblock %}

{% block content %}
<div class="dashboard-welcome">
    <h1>Surveillance Dashboard</h1>
    <p>Select a database to manage surveillance.</p>
    
    {% if camera_active %}
    <div style="background-color: {% if weapon_active %}#fef2f2{% else %}#e8f5e9{% endif %}; border: 1px solid {% if weapon_active %}#fecaca{% else %}#c8e6c9{% endif %}; padding: 20px; border-radius: 8px; margin-top: 20px; margin-bottom: 10px; text-align: center; animation: fadeIn 0.5s;">
        {% if weapon_active %}
        <h3 style="color: #b91c1c; margin-bottom: 10px;"><i class="fas fa-crosshairs" style="margin-right: 10px;"></i> Weapon Detection Active</h3>
        <p style="color: #555; margin-bottom: 20px;">AI-powered threat detection is actively scanning the camera feed.</p>
        
        <div style="display: flex; justify-content: center; gap: 15px;">
            <a href="{{ url_for('weapon_detection') }}" class="btn btn-primary" style="background-color: #b91c1c;">
                <i class="fas fa-eye"></i> View Detection Stream
            </a>
            <a href="{{ url_for('stop_weapon_detection') }}" class="btn btn-secondary" style="background-color: #374151; color: white; border: none;">
                <i class="fas fa-stop-circle"></i> Stop Detection
            </a>
        </div>
        {% else %}
        <h3 style="color: #2e7d32; margin-bottom: 10px;"><i class="fas fa-video" style="margin-right: 10px;"></i> Surveillance Active</h3>
        <p style="color: #555; margin-bottom: 20px;">System is currently monitoring <strong>{{ camera_mode|upper }}</strong> targets in the background.</p>
        
        <div style="display: flex; justify-content: center; gap: 15px;">
            <a href="{{ url_for('start_surveillance_stream', mode=camera_mode) }}" class="btn btn-primary" style="background-color: #2e7d32;">
                <i class="fas fa-eye"></i> View Live Stream
            </a>
            <a href="{{ url_for('stop_surveillance_stream') }}" class="btn btn-secondary" style="background-color: #c62828; color: white; border: none;">
                <i class="fas fa-stop-circle"></i> Stop Surveillance
            </a>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div style="margin-top: 25px; text-align: center;">
        <button class="btn btn-primary" style="padding: 15px 40px; font-size: 1.3rem; border-radius: 50px; box-shadow: 0 4px 20px rgba(211, 47, 47, 0.4); background: linear-gradient(45deg, #D32F2F, #B71C1C); border: none;" onclick="openSurveillanceModal()">
            <i class="fas fa-video" style="margin-right: 10px;"></i> Start Surveillance System
        </button>
    </div>
    
    <div class="dashboard-cards" style="display: flex; gap: 20px; margin-top: 30px;">
        <div class="card" style="padding: 20px; border: 1px solid #eee; border-radius: 8px; width: 250px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onclick='window.location="{{ url_for("surveillance_view", db_type="criminal") }}";' onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
            <i class="fas fa-user-secret" style="font-size: 3rem; color: #D32F2F; margin-bottom: 15px;"></i>
            <h3>Criminal Surveillance Active List</h3>
            <p style="color: #666; font-size: 0.9rem; margin-top: 10px;">Monitor active criminals</p>
        </div>
        
        <div class="card" style="padding: 20px; border: 1px solid #eee; border-radius: 8px; width: 250px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onclick='window.location="{{ url_for("surveillance_view", db_type="missing") }}";' onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
            <i class="fas fa-user-clock" style="font-size: 3rem; color: #1976D2; margin-bottom: 15px;"></i>
            <h3>Missing Person Surveillance Active List</h3>
            <p style="color: #666; font-size: 0.9rem; margin-top: 10px;">Track missing persons</p>
        </div>
    </div>

    <!-- Modal -->
    <div id="surveillanceModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px);">
        <div class="modal-content" style="background-color: #fefefe; margin: 10% auto; padding: 40px; border: none; width: 90%; max-width: 500px; border-radius: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); position: relative; animation: modalFadeIn 0.3s;">
            <span class="close" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; right: 25px; top: 15px; transition: color 0.2s;" onclick="closeSurveillanceModal()" onmouseover="this.style.color='#333'" onmouseout="this.style.color='#aaa'">&times;</span>
            
            <div style="margin-bottom: 30px;">
                <i class="fas fa-cctv" style="font-size: 4rem; color: #333; margin-bottom: 20px;"></i>
                <h2 style="margin-bottom: 10px; color: #333;">Start Surveillance</h2>
                <p style="color: #666;">Select the target database for real-time monitoring</p>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <button class="btn" style="background-color: #D32F2F; color: white; padding: 18px; font-size: 1.1rem; border-radius: 12px; justify-content: center; transition: transform 0.2s;" onclick="checkAndStart('criminal')" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                    <i class="fas fa-user-secret" style="font-size: 1.4rem;"></i> Criminal Active Surveillance
                </button>
                
                <button class="btn" style="background-color: #1976D2; color: white; padding: 18px; font-size: 1.1rem; border-radius: 12px; justify-content: center; transition: transform 0.2s;" onclick="checkAndStart('missing')" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                    <i class="fas fa-user-clock" style="font-size: 1.4rem;"></i> Missing Person Active Surveillance
                </button>

                <button class="btn" style="background-color: #4CAF50; color: white; padding: 18px; font-size: 1.1rem; border-radius: 12px; justify-content: center; transition: transform 0.2s;" onclick="checkAndStart('both')" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                    <i class="fas fa-users" style="font-size: 1.4rem;"></i> Start Surveillance for Both
                </button>
            </div>
        </div>
    </div>

    <!-- Empty List Modal -->
    <div id="emptyListModal" class="modal" style="display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px);">
        <div class="modal-content" style="background-color: #fefefe; margin: 15% auto; padding: 40px; border: none; width: 90%; max-width: 450px; border-radius: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); position: relative; animation: modalFadeIn 0.3s;">
            <span class="close" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; right: 25px; top: 15px;" onclick="closeEmptyModal()">&times;</span>
            
            <div style="margin-bottom: 20px;">
                <i class="fas fa-exclamation-circle" style="font-size: 4rem; color: #FF9800; margin-bottom: 20px;"></i>
                <h2 style="margin-bottom: 10px; color: #333;">No Active Targets</h2>
                <p style="color: #666;">There are no active suspects in the selected list.</p>
            </div>
            
            <div id="emptyModalActions" style="display: flex; flex-direction: column; gap: 15px;">
                <!-- Buttons injected by JS -->
            </div>
        </div>
    </div>

    <!-- Partial List Modal -->
    <div id="partialListModal" class="modal" style="display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px);">
        <div class="modal-content" style="background-color: #fefefe; margin: 15% auto; padding: 40px; border: none; width: 90%; max-width: 450px; border-radius: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); position: relative; animation: modalFadeIn 0.3s;">
            <span class="close" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; right: 25px; top: 15px;" onclick="closePartialModal()">&times;</span>
            
            <div style="margin-bottom: 20px;">
                <i class="fas fa-info-circle" style="font-size: 4rem; color: #2196F3; margin-bottom: 20px;"></i>
                <h2 style="margin-bottom: 10px; color: #333;">Partial Active Targets</h2>
                <p id="partialMessage" style="color: #666; margin-bottom: 20px;"></p>
            </div>
            
            <div id="partialModalActions" style="display: flex; flex-direction: column; gap: 15px;">
                <!-- Buttons injected by JS -->
            </div>
        </div>
    </div>

    <!-- Run Mode Modal -->
    <div id="runModeModal" class="modal" style="display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px);">
        <div class="modal-content" style="background-color: #fefefe; margin: 15% auto; padding: 40px; border: none; width: 90%; max-width: 450px; border-radius: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); position: relative; animation: modalFadeIn 0.3s;">
            <span class="close" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; right: 25px; top: 15px;" onclick="closeRunModeModal()">&times;</span>
            
            <div style="margin-bottom: 20px;">
                <i class="fas fa-play-circle" style="font-size: 4rem; color: #2196F3; margin-bottom: 20px;"></i>
                <h2 style="margin-bottom: 10px; color: #333;">Choose Mode</h2>
                <p style="color: #666;">How would you like to run the surveillance?</p>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <button class="btn" style="background-color: #607D8B; color: white; padding: 15px; font-size: 1.1rem; border-radius: 8px; justify-content: center;" onclick="startBackground()">
                    <i class="fas fa-cog" style="margin-right: 10px;"></i> Run in Background
                </button>
                <button class="btn" style="background-color: #D32F2F; color: white; padding: 15px; font-size: 1.1rem; border-radius: 8px; justify-content: center;" onclick="startLive()">
                    <i class="fas fa-video" style="margin-right: 10px;"></i> View Live Stream
                </button>
            </div>
        </div>
    </div>

    <style>
        @keyframes modalFadeIn {
            from {opacity: 0; transform: translateY(-20px);}
            to {opacity: 1; transform: translateY(0);}
        }
    </style>

    <script>
        let selectedMode = '';

        function openSurveillanceModal() {
            document.getElementById('surveillanceModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeSurveillanceModal() {
            document.getElementById('surveillanceModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function closeEmptyModal() {
            document.getElementById('emptyListModal').style.display = 'none';
        }

        function closePartialModal() {
            document.getElementById('partialListModal').style.display = 'none';
        }

        function closeRunModeModal() {
            document.getElementById('runModeModal').style.display = 'none';
        }

        function checkAndStart(type) {
            selectedMode = type;
            
            // Check active targets count
            fetch('/api/surveillance/check_targets/' + type)
                .then(response => response.json())
                .then(data => {
                    if (type === 'both') {
                        if (data.criminal_count === 0 && data.missing_count === 0) {
                            showEmptyModal('both');
                        } else if (data.criminal_count === 0) {
                            showPartialModal('criminal');
                        } else if (data.missing_count === 0) {
                            showPartialModal('missing');
                        } else {
                            showRunModeModal();
                        }
                    } else {
                        if (data.count === 0) {
                            showEmptyModal(type);
                        } else {
                            showRunModeModal();
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error checking surveillance status');
                });
        }

        function showEmptyModal(type) {
            closeSurveillanceModal();
            const modal = document.getElementById('emptyListModal');
            const actions = document.getElementById('emptyModalActions');
            actions.innerHTML = '';

            if (type === 'criminal') {
                actions.innerHTML = `<a href="{{ url_for('surveillance_view', db_type='criminal') }}" class="btn btn-primary" style="justify-content: center;">Go to Criminal Surveillance List</a>`;
            } else if (type === 'missing') {
                actions.innerHTML = `<a href="{{ url_for('surveillance_view', db_type='missing') }}" class="btn btn-primary" style="justify-content: center;">Go to Missing Person Surveillance List</a>`;
            } else {
                actions.innerHTML = `
                    <a href="{{ url_for('surveillance_view', db_type='criminal') }}" class="btn btn-primary" style="justify-content: center; margin-bottom: 10px;">Go to Criminal List</a>
                    <a href="{{ url_for('surveillance_view', db_type='missing') }}" class="btn btn-secondary" style="justify-content: center;">Go to Missing Person List</a>
                `;
            }
            
            modal.style.display = 'block';
        }

        function showPartialModal(missingType) {
            closeSurveillanceModal();
            const modal = document.getElementById('partialListModal');
            const message = document.getElementById('partialMessage');
            const actions = document.getElementById('partialModalActions');
            
            if (missingType === 'criminal') {
                message.textContent = "There are no active Criminal targets. Do you want to add criminals or start surveillance for Missing Persons only?";
                actions.innerHTML = `
                    <button class="btn" style="background-color: #4CAF50; color: white; padding: 15px; justify-content: center;" onclick="startWithAvailable('missing')">
                        Start Missing Person Surveillance Only
                    </button>
                    <a href="{{ url_for('surveillance_view', db_type='criminal') }}" class="btn btn-secondary" style="justify-content: center;">
                        Go to Add Criminals
                    </a>
                `;
            } else {
                message.textContent = "There are no active Missing Person targets. Do you want to add missing persons or start surveillance for Criminals only?";
                actions.innerHTML = `
                    <button class="btn" style="background-color: #D32F2F; color: white; padding: 15px; justify-content: center;" onclick="startWithAvailable('criminal')">
                        Start Criminal Surveillance Only
                    </button>
                    <a href="{{ url_for('surveillance_view', db_type='missing') }}" class="btn btn-secondary" style="justify-content: center;">
                        Go to Add Missing Persons
                    </a>
                `;
            }
            
            modal.style.display = 'block';
        }

        function startWithAvailable(newMode) {
            selectedMode = newMode;
            closePartialModal();
            showRunModeModal();
        }

        function showRunModeModal() {
            closeSurveillanceModal();
            document.getElementById('runModeModal').style.display = 'block';
        }

        function startBackground() {
            window.location.href = '/start_surveillance_background/' + selectedMode;
        }

        function startLive() {
            window.location.href = '/start_surveillance_stream/' + selectedMode;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == document.getElementById('surveillanceModal')) closeSurveillanceModal();
            if (event.target == document.getElementById('emptyListModal')) closeEmptyModal();
            if (event.target == document.getElementById('partialListModal')) closePartialModal();
            if (event.target == document.getElementById('runModeModal')) closeRunModeModal();
        }
    </script>
</div>
{% endblock %}
