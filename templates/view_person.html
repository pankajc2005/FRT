{% extends "layout.html" %}

{% block content %}
<div class="create-item-container">
    <form action="{{ url_for('update_person', person_id=person.id) }}" method="POST" id="updateForm">
        <div class="create-header">
            <div class="header-left">
                <a href="{{ url_for('missing_dashboard') if person.db_type == 'missing' else url_for('criminal_dashboard') }}" class="back-btn"><i class="fas fa-arrow-left"></i></a>
                <div class="header-title">
                    <span class="breadcrumb-small">{{ 'Missing DB' if person.db_type == 'missing' else 'Criminal DB' }}</span>
                    <h2>View / Edit Item</h2>
                </div>
            </div>
            <div class="header-right">
                <button type="button" class="btn-circle-menu" onclick="confirmDelete()" style="background-color: #ffebee; color: #c62828; margin-right: 10px;"><i class="fas fa-trash"></i></button>
                <button type="submit" class="btn-circle-check"><i class="fas fa-check"></i></button>
            </div>
        </div>

        <div class="form-content">
            <!-- Surveillance Status Card -->
            <div class="form-section" style="background: {% if person.surveillance %}#f0fdf4{% else %}#fef2f2{% endif %}; border: 1px solid {% if person.surveillance %}#bbf7d0{% else %}#fecaca{% endif %}; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin: 0 0 0.25rem 0; font-size: 1rem; color: {% if person.surveillance %}#166534{% else %}#991b1b{% endif %};">
                            <i class="fas fa-{% if person.surveillance %}eye{% else %}eye-slash{% endif %}"></i>
                            Surveillance Status
                        </h3>
                        <p style="margin: 0; font-size: 0.85rem; color: #6b7280;">
                            {% if person.surveillance %}
                            This person is currently being monitored by the surveillance system.
                            {% else %}
                            Surveillance is not active for this person.
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        {% if person.surveillance %}
                        <button type="button" onclick="showDeactivateModal()" 
                                style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-power-off"></i> Deactivate
                        </button>
                        {% else %}
                        <button type="button" onclick="showActivateModal()" 
                                style="background: #16a34a; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-power-off"></i> Activate
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="form-section">
                <label class="section-label">{{ 'Missing Person Photo' if person.db_type == 'missing' else 'Suspect Photo' }}</label>
                <div class="file-upload-area" data-bg="{{ url_for('serve_image', filename=person.image_filename) }}" style="background-size: contain; background-repeat: no-repeat; background-position: center;">
                    <!-- Image is shown via background -->
                </div>
            </div>

            <div class="form-section">
                <label class="section-label">{{ 'Name' if person.db_type == 'missing' else 'Suspect Name' }}</label>
                <input type="text" name="name" class="form-input" value="{{ person.name }}">
            </div>

            <div class="form-section">
                <label class="section-label">{{ 'Missing Person Aadhaar' if person.db_type == 'missing' else 'Suspect Aadhaar No' }}</label>
                <div class="select-wrapper">
                    <input type="text" name="aadhaar" class="form-input" value="{{ person.aadhaar or person.missing_aadhaar or '' }}">
                </div>
            </div>

            <div class="form-section">
                <label class="section-label">{{ 'Guardian Phone No' if person.db_type == 'missing' else 'Suspect Phone No' }}</label>
                <input type="text" name="phone" class="form-input" value="{{ person.phone or person.guardian_phone or '' }}">
            </div>
            
            <div class="form-section">
                <label class="section-label">Gender</label>
                <div class="select-wrapper">
                    {% set current_gender = person.submitted_gender or person.predicted_gender %}
                    <select name="gender" class="form-input">
                        <option value="Male" {% if current_gender == 'Male' %}selected{% endif %}>Male</option>
                        <option value="Female" {% if current_gender == 'Female' %}selected{% endif %}>Female</option>
                        <option value="Other" {% if current_gender == 'Other' %}selected{% endif %}>Other</option>
                    </select>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>

            <div class="form-section">
                <label class="section-label">Embedding Dlib 128D</label>
                <div class="embeddings-box" style="display: block; overflow: auto; max-height: 150px; font-family: monospace; white-space: pre-wrap; color: #333; font-size: 0.8rem;">
                    {{ person.embeddings.dlib }}
                </div>
            </div>

            <div class="form-section">
                <label class="section-label">Embedding ArcFace 512D</label>
                <div class="embeddings-box" style="display: block; overflow: auto; max-height: 150px; font-family: monospace; white-space: pre-wrap; color: #333; font-size: 0.8rem;">
                    {{ person.embeddings.arcface }}
                </div>
            </div>
        </div>
    </form>
</div>

<form id="deleteForm" action="{{ url_for('delete_person', person_id=person.id) }}" method="POST" style="display: none;"></form>

<!-- Activate Surveillance Modal -->
<div id="activate-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:1rem; width:90%; max-width:450px; overflow:hidden;">
        <div style="padding:1rem 1.5rem; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; background: linear-gradient(135deg, #16a34a, #15803d);">
            <h2 style="margin:0; font-size:1.1rem; color: white;"><i class="fas fa-eye"></i> Activate Surveillance</h2>
            <button onclick="hideActivateModal()" style="border:none; background:none; cursor:pointer; font-size:1.5rem; line-height:1; color:white;">&times;</button>
        </div>
        <div style="padding:1.5rem;">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="width: 70px; height: 70px; background: #f0fdf4; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                    <i class="fas fa-user-shield" style="font-size: 1.8rem; color: #16a34a;"></i>
                </div>
                <h3 style="margin: 0 0 0.5rem; color: #1f2937;">Enable Surveillance for {{ person.name }}</h3>
                <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">
                    This will add the person to active monitoring. All detection events will be logged.
                </p>
            </div>

            <div style="background: #fffbeb; border: 1px solid #f59e0b; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #92400e;">
                    <i class="fas fa-shield-alt"></i>
                    <span>Authorization required - This action will be logged</span>
                </div>
            </div>
            
            <form id="activateForm" method="POST" action="{{ url_for('surveillance_activate', person_id=person.id) }}">
                <input type="hidden" name="db_type" value="{{ person.db_type }}">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Officer Password</label>
                    <input type="password" name="password" required placeholder="Enter your password"
                           style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem;">
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Reason for Activation</label>
                    <textarea name="reason" required placeholder="Enter reason for surveillance activation..."
                              style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; min-height: 80px;"></textarea>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" onclick="hideActivateModal()" 
                            style="flex: 1; padding: 0.75rem; background: white; border: 1px solid #d1d5db; border-radius: 0.5rem; cursor: pointer;">
                        Cancel
                    </button>
                    <button type="submit" 
                            style="flex: 1; padding: 0.75rem; background: #16a34a; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-check"></i> Authorize & Activate
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Deactivate Surveillance Modal -->
<div id="deactivate-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:1rem; width:90%; max-width:450px; overflow:hidden;">
        <div style="padding:1rem 1.5rem; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; background: linear-gradient(135deg, #dc2626, #b91c1c);">
            <h2 style="margin:0; font-size:1.1rem; color: white;"><i class="fas fa-eye-slash"></i> Deactivate Surveillance</h2>
            <button onclick="hideDeactivateModal()" style="border:none; background:none; cursor:pointer; font-size:1.5rem; line-height:1; color:white;">&times;</button>
        </div>
        <div style="padding:1.5rem;">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="width: 70px; height: 70px; background: #fef2f2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                    <i class="fas fa-user-times" style="font-size: 1.8rem; color: #dc2626;"></i>
                </div>
                <h3 style="margin: 0 0 0.5rem; color: #1f2937;">Stop Surveillance for {{ person.name }}</h3>
                <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">
                    This will remove the person from active monitoring.
                </p>
            </div>

            <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #991b1b;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Authorization required - This action will be logged</span>
                </div>
            </div>
            
            <form id="deactivateForm" method="POST" action="{{ url_for('surveillance_deactivate', person_id=person.id) }}">
                <input type="hidden" name="db_type" value="{{ person.db_type }}">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Officer Password</label>
                    <input type="password" name="password" required placeholder="Enter your password"
                           style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem;">
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Reason for Deactivation</label>
                    <textarea name="reason" required placeholder="Enter reason for stopping surveillance..."
                              style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; min-height: 80px;"></textarea>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" onclick="hideDeactivateModal()" 
                            style="flex: 1; padding: 0.75rem; background: white; border: 1px solid #d1d5db; border-radius: 0.5rem; cursor: pointer;">
                        Cancel
                    </button>
                    <button type="submit" 
                            style="flex: 1; padding: 0.75rem; background: #dc2626; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-stop-circle"></i> Authorize & Deactivate
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function confirmDelete() {
    if (confirm('Are you sure you want to delete this person? This action cannot be undone.')) {
        document.getElementById('deleteForm').submit();
    }
}

function showActivateModal() {
    document.getElementById('activate-modal').style.display = 'flex';
}

function hideActivateModal() {
    document.getElementById('activate-modal').style.display = 'none';
}

function showDeactivateModal() {
    document.getElementById('deactivate-modal').style.display = 'flex';
}

function hideDeactivateModal() {
    document.getElementById('deactivate-modal').style.display = 'none';
}

// Close modal when clicking outside
document.getElementById('activate-modal').addEventListener('click', function(e) {
    if (e.target === this) hideActivateModal();
});
document.getElementById('deactivate-modal').addEventListener('click', function(e) {
    if (e.target === this) hideDeactivateModal();
});

// Set background images
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-bg]').forEach(el => {
        el.style.backgroundImage = "url('" + el.dataset.bg + "')";
    });
});
</script>
{% endblock %}
