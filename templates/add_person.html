{% extends "layout.html" %}

{% block content %}
<div class="create-item-container">
    <form action="{{ url_for('add_person') }}" method="post" enctype="multipart/form-data" id="createForm">
        <div class="create-header">
            <div class="header-left">
                <a href="{{ url_for('criminal_dashboard') }}" class="back-btn"><i class="fas fa-arrow-left"></i></a>
                <div class="header-title">
                    <span class="breadcrumb-small">Criminal DB</span>
                    <h2>Creating Item in Criminal DB</h2>
                </div>
            </div>
            <div class="header-right">
                <button type="submit" class="btn-circle-check"><i class="fas fa-check"></i></button>
                <button type="button" class="btn-circle-menu"><i class="fas fa-ellipsis-v"></i></button>
            </div>
        </div>

        <div class="form-content">
            <div class="form-section">
                <label class="section-label">Suspect Photo</label>
                <div class="file-upload-area">
                    <input type="file" id="image" name="image" accept="image/*" required onchange="previewImage(this)">
                    <div class="upload-placeholder" id="imagePreview">
                        <div class="upload-icons">
                            <i class="fas fa-upload"></i>
                            <i class="far fa-folder"></i>
                            <i class="fas fa-link"></i>
                        </div>
                        <span>Drag & Drop a File Here</span>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <label class="section-label">Suspect Name</label>
                <input type="text" name="name" class="form-input" placeholder="Enter Suspect Name" required>
            </div>

            <div class="form-section">
                <label class="section-label">Suspect Aadhaar No</label>
                <div class="select-wrapper">
                    <input type="text" name="aadhaar" id="aadhaarInput" class="form-input" placeholder="Enter Aadhaar No">
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div id="aadhaarError" class="validation-error" style="display:none; color: #D32F2F; margin-top: 5px; font-size: 0.9rem;">
                    <i class="fas fa-exclamation-circle"></i> <span></span>
                </div>
            </div>

            <div class="form-section">
                <label class="section-label">Suspect Phone No</label>
                <input type="text" name="phone" id="phoneInput" class="form-input" placeholder="Enter Suspect Phone No">
                <div id="phoneError" class="validation-error" style="display:none; color: #D32F2F; margin-top: 5px; font-size: 0.9rem;">
                    <i class="fas fa-exclamation-circle"></i> <span></span>
                </div>
            </div>
            
            <div class="form-section">
                <label class="section-label">Gender</label>
                <div class="select-wrapper">
                    <select name="gender" class="form-input" required>
                        <option value="" disabled selected>Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>

            <div class="form-section">
                <label class="section-label">Criminalface Embeddings</label>
                <div class="embeddings-box">
                    <span class="line-number">1</span>
                    <span class="placeholder-text">Embeddings will be generated automatically...</span>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
function previewImage(input) {
    var preview = document.getElementById('imagePreview');
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            preview.style.backgroundImage = 'url(' + e.target.result + ')';
            preview.innerHTML = ''; 
            preview.classList.add('has-image');
        }
        reader.readAsDataURL(input.files[0]);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const aadhaarInput = document.getElementById('aadhaarInput');
    const phoneInput = document.getElementById('phoneInput');
    
    function checkDuplicate(input, errorId, type) {
        const value = input.value.trim();
        const errorDiv = document.getElementById(errorId);
        
        if (value.length > 3) { 
            fetch(`/api/search?q=${encodeURIComponent(value)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const match = data[0];
                        errorDiv.style.display = 'block';
                        errorDiv.querySelector('span').innerText = `Warning: This ${type} may already exist (Name: ${match.name}).`;
                        input.style.borderColor = '#D32F2F';
                    } else {
                        errorDiv.style.display = 'none';
                        input.style.borderColor = ''; 
                    }
                });
        } else {
            errorDiv.style.display = 'none';
            input.style.borderColor = '';
        }
    }

    if (aadhaarInput) aadhaarInput.addEventListener('blur', () => checkDuplicate(aadhaarInput, 'aadhaarError', 'Aadhaar'));
    if (phoneInput) phoneInput.addEventListener('blur', () => checkDuplicate(phoneInput, 'phoneError', 'Phone'));
});
</script>
{% endblock %}
