{% extends "layout.html" %}

{% block content %}
<div style="padding: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h1 style="margin: 0; color: #1f2937; font-size: 2rem;">
                <i class="fas fa-video"></i> Surveillance Requests
            </h1>
            <p style="color: #6b7280; margin: 0.5rem 0 0 0;">Review and manage officer surveillance requests</p>
        </div>
        <button onclick="window.location.href='{{ url_for('index') }}'" 
                style="padding: 0.75rem 1.5rem; background: white; border: 2px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer; color: #374151; font-weight: 600; transition: all 0.2s;">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </button>
    </div>

    <!-- Statistics Cards -->
    <!-- <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 0.75rem; padding: 1.5rem; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <p style="margin: 0; opacity: 0.9; font-size: 0.875rem;">Pending Requests</p>
                    <h2 id="pending-count" style="margin: 0.5rem 0 0 0; font-size: 2.5rem; font-weight: 700;">0</h2>
                </div>
                <div style="background: rgba(255,255,255,0.2); border-radius: 0.5rem; padding: 0.75rem;">
                    <i class="fas fa-clock" style="font-size: 2rem;"></i>
                </div>
            </div>
        </div>

        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 0.75rem; padding: 1.5rem; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <p style="margin: 0; opacity: 0.9; font-size: 0.875rem;">Approved Today</p>
                    <h2 id="approved-count" style="margin: 0.5rem 0 0 0; font-size: 2.5rem; font-weight: 700;">0</h2>
                </div>
                <div style="background: rgba(255,255,255,0.2); border-radius: 0.5rem; padding: 0.75rem;">
                    <i class="fas fa-check-circle" style="font-size: 2rem;"></i>
                </div>
            </div>
        </div>

        <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 0.75rem; padding: 1.5rem; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <p style="margin: 0; opacity: 0.9; font-size: 0.875rem;">Rejected Today</p>
                    <h2 id="rejected-count" style="margin: 0.5rem 0 0 0; font-size: 2.5rem; font-weight: 700;">0</h2>
                </div>
                <div style="background: rgba(255,255,255,0.2); border-radius: 0.5rem; padding: 0.75rem;">
                    <i class="fas fa-times-circle" style="font-size: 2rem;"></i>
                </div>
            </div>
        </div>
    </div> -->

    <!-- Requests List -->
    <div style="background: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0; color: #1f2937; font-size: 1.5rem;">
                <i class="fas fa-list"></i> Pending Requests
            </h2>
            <button onclick="loadSurveillanceRequests()" 
                    style="padding: 0.5rem 1rem; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 0.375rem; cursor: pointer; color: #374151; transition: all 0.2s;">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
        
        <div id="pending-requests-container">
            <!-- Requests will be loaded here -->
        </div>
    </div>
</div>

<script>
// Load surveillance requests on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSurveillanceRequests();
    loadStatistics();
    
    // Auto-refresh every 30 seconds
    setInterval(() => {
        loadSurveillanceRequests();
        loadStatistics();
    }, 30000);
});

function loadSurveillanceRequests() {
    fetch('/admin/settings/surveillance_requests')
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById('pending-requests-container');
            
            if (data.requests && data.requests.length > 0) {
                container.innerHTML = data.requests.map(req => {
                    // Determine image path based on request type
                    let imageSrc = '';
                    if (req.type === 'new_person') {
                        // New person request - image is in pending folder
                        let pendingFilename = req.image_filename;
                        if (!pendingFilename && req.image_path) {
                            const segments = req.image_path.split(/[/\\\\]/);
                            pendingFilename = segments[segments.length - 1];
                        }
                        if (pendingFilename) {
                            imageSrc = `/data/pending_requests/images/${pendingFilename}`;
                        }
                    } else if (req.image_filename) {
                        // Existing person - image in regular folders
                        const folder = req.db_type === 'criminal' ? 'persons' : 'missing_persons';
                        imageSrc = `/data/images/${req.image_filename}`;
                    }
                    
                    // Determine priority display
                    let priorityText = '';
                    let priorityColor = '';
                    if (typeof req.priority === 'number') {
                        // Numeric priority (1-5)
                        priorityText = `Priority ${req.priority}`;
                        priorityColor = req.priority <= 2 ? '#dc2626' : req.priority === 3 ? '#d97706' : '#059669';
                    } else {
                        // Text priority (high/medium/low)
                        priorityText = req.priority.charAt(0).toUpperCase() + req.priority.slice(1);
                        priorityColor = req.priority === 'high' ? '#dc2626' : req.priority === 'medium' ? '#d97706' : '#059669';
                    }
                    
                    const submittedInfo = req.type === 'new_person' ? `
                        <div style="background: white; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                            <strong style="color: #374151; display: block; margin-bottom: 0.75rem;">Submitted Details</strong>
                            <div style="display: grid; gap: 0.75rem; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                                <div>
                                    <span style="display: block; color: #6b7280; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em;">Phone</span>
                                    <span style="font-weight: 600; color: #1f2937;">${req.phone || '‚Äî'}</span>
                                </div>
                                <div>
                                    <span style="display: block; color: #6b7280; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em;">Gender</span>
                                    <span style="font-weight: 600; color: #1f2937;">${req.gender || '‚Äî'}</span>
                                </div>
                                <div>
                                    <span style="display: block; color: #6b7280; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em;">Age</span>
                                    <span style="font-weight: 600; color: #1f2937;">${req.age || '‚Äî'}</span>
                                </div>
                                <div>
                                    <span style="display: block; color: #6b7280; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em;">Additional Notes</span>
                                    <span style="font-weight: 600; color: #1f2937;">${req.details || '‚Äî'}</span>
                                </div>
                            </div>
                        </div>
                    ` : '';

                    return `
                    <div id="request-${req.id}" style="background: #f9fafb; border-left: 4px solid ${priorityColor}; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem; position: relative;">
                        ${req.type === 'new_person' ? `
                            <div style="position: absolute; top: 1rem; right: 1rem; background: #8b5cf6; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
                                <i class="fas fa-plus-circle"></i> NEW PERSON
                            </div>
                        ` : ''}
                        <div style="display: flex; gap: 1.5rem; align-items: start;">
                            <div style="flex-shrink: 0;">
                                ${imageSrc ? `
                                    <img src="${imageSrc}" 
                                         style="width: 120px; height: 120px; object-fit: cover; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                         onerror="this.src='/static/images/default-person.jpg'">
                                ` : `
                                    <div style="width: 120px; height: 120px; background: #e5e7eb; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-user" style="font-size: 3rem; color: #9ca3af;"></i>
                                    </div>
                                `}
                            </div>
                            
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                    <div>
                                        <h3 style="margin: 0 0 0.5rem 0; color: #1f2937; font-size: 1.25rem;">
                                            ${req.person_name || req.name}
                                            <span style="display: inline-block; padding: 0.25rem 0.75rem; background: ${req.person_type === 'criminal' || req.db_type === 'criminal' ? '#fee2e2' : '#dbeafe'}; color: ${req.person_type === 'criminal' || req.db_type === 'criminal' ? '#991b1b' : '#1e40af'}; border-radius: 9999px; font-size: 0.75rem; margin-left: 0.5rem;">
                                                ${req.person_type === 'criminal' || req.db_type === 'criminal' ? '‚ö†Ô∏è Criminal' : 'üîç Missing'}
                                            </span>
                                        </h3>
                                        <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: #6b7280;">
                                            <span><i class="fas fa-user-shield"></i> ${req.requested_by}</span>
                                            <span><i class="fas fa-clock"></i> ${new Date(req.requested_at).toLocaleString()}</span>
                                            <span style="color: ${priorityColor};">
                                                <i class="fas fa-flag"></i> ${priorityText}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="background: white; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                                    <strong style="color: #374151; display: block; margin-bottom: 0.5rem;">Reason for Request:</strong>
                                    <p style="margin: 0; color: #4b5563; line-height: 1.6;">${req.reason}</p>
                                </div>

                                ${submittedInfo}
                                
                                <div style="display: flex; gap: 0.75rem;">
                                    <button onclick="reviewRequest('${req.id}', 'approve')" 
                                            style="flex: 1; padding: 0.75rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; transition: transform 0.2s;">
                                        <i class="fas fa-check-circle"></i> Approve & Activate Surveillance
                                    </button>
                                    <button onclick="reviewRequest('${req.id}', 'reject')" 
                                            style="flex: 1; padding: 0.75rem; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; transition: transform 0.2s;">
                                        <i class="fas fa-times-circle"></i> Reject Request
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
            } else {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <i class="fas fa-inbox" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p style="margin: 0; font-size: 1.1rem;">No pending surveillance requests</p>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">Requests from officers will appear here</p>
                    </div>
                `;
            }
        })
        .catch(err => {
            console.error('Error loading requests:', err);
            document.getElementById('pending-requests-container').innerHTML = `
                <div style="background: #fee2e2; border: 1px solid #ef4444; border-radius: 0.5rem; padding: 1rem; color: #991b1b;">
                    <i class="fas fa-exclamation-triangle"></i> Error loading surveillance requests
                </div>
            `;
        });
}

function loadStatistics() {
    fetch('/admin/settings/surveillance_requests')
        .then(res => res.json())
        .then(data => {
            // Count pending requests
            const pendingCount = data.requests ? data.requests.length : 0;
            document.getElementById('pending-count').textContent = pendingCount;
            
            // Load all requests to count today's approved/rejected
            fetch('/admin/settings/surveillance_requests')
                .then(res => res.json())
                .then(allData => {
                    // For now, just show 0 for approved/rejected
                    // You can enhance this to count from surveillance_requests.json
                    document.getElementById('approved-count').textContent = '0';
                    document.getElementById('rejected-count').textContent = '0';
                });
        });
}

function reviewRequest(requestId, action) {
    const confirmMsg = action === 'approve' 
        ? 'Approve this surveillance request? The person will be added to active surveillance.'
        : 'Reject this surveillance request?';
    
    const adminNotes = action === 'reject' ? prompt('Reason for rejection (optional):') : null;
    if (action === 'reject' && adminNotes === null) return; // User cancelled
    
    if (!confirm(confirmMsg)) return;
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    fetch('/admin/settings/review_surveillance_request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            request_id: requestId,
            action: action,
            admin_notes: adminNotes
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            // Remove the request card with animation
            const card = document.getElementById('request-' + requestId);
            card.style.transition = 'all 0.3s';
            card.style.opacity = '0';
            card.style.transform = 'translateX(20px)';
            setTimeout(() => {
                card.remove();
                loadSurveillanceRequests(); // Reload to check if empty
                loadStatistics(); // Update statistics
            }, 300);
            
            alert(data.message);
        } else {
            btn.innerHTML = originalText;
            btn.disabled = false;
            alert('Error: ' + data.message);
        }
    })
    .catch(err => {
        console.error('Error reviewing request:', err);
        btn.innerHTML = originalText;
        btn.disabled = false;
        alert('Error processing request');
    });
}
</script>

<style>
button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

button:active {
    transform: translateY(0);
}
</style>
{% endblock %}
