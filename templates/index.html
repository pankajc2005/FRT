{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block header_actions %}
    <!-- Top Bar Actions -->
    <button class="btn-circle-add" onclick="openCaptureModal()" title="Live Camera">
        <i class="fas fa-camera"></i>
    </button>
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">

<div class="dashboard-container">
    <!-- 1. Info Header -->
    <div class="dashboard-header-info">
        <div class="station-info">
            <h1>TRINETRA - FACE RECOGNITION SYSTEM</h1>
            <div style="font-size: 0.85rem; color: #6b7280; margin-top: 0.25rem;">
                <i class="fas fa-building"></i> Station: Vile Parle PS &nbsp;|&nbsp; 
                <i class="fas fa-user-shield"></i> Officer: {{ current_user.username }}
            </div>
        </div>
        <div class="system-status">
            <div class="status-badge">
                <div id="camera-status" class="status-dot active blink"></div> Camera
            </div>
            <div class="status-badge">
                <div id="model-status" class="status-dot active"></div> ArcFace
            </div>
            <div class="status-badge">
                <div id="sync-status" class="status-dot active"></div> Sync: <span id="system-time">--:--</span>
            </div>
        </div>
    </div>

    <!-- 2. Split Layout -->
    <div class="dashboard-grid">
        <!-- LEFT PANEL: Quick Actions -->
        <div class="query-panel">
            <div class="panel-header">
                <h2><i class="fas fa-th-large"></i> Quick Actions</h2>
            </div>
            <div class="quick-actions-grid">
                <!-- Wanted Criminal Detection -->
                <a href="{{ url_for('add_wanted_criminal') }}" class="action-box">
                    <div class="action-icon" style="color: #D32F2F;">
                        <i class="fas fa-crosshairs"></i>
                    </div>
                    <h3>Wanted Detection</h3>
                    <p>Add priority 1 criminal</p>
                </a>

                <!-- Crowd Detection -->
                <div class="action-box" onclick="requestCrowdDetectionPermission()" style="cursor:pointer;">
                    <div class="action-icon" style="color: #7c3aed;">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3>Crowd Detection</h3>
                    <p>Monitor crowd density</p>
                </div>

                <!-- Weapon Detection -->
                <div class="action-box" onclick="requestWeaponDetectionPermission()" style="cursor:pointer;">
                    <div class="action-icon" style="color: #b91c1c;">
                        <i class="fas fa-gun"></i>
                    </div>
                    <h3>Weapon Detection</h3>
                    <p>AI-powered threat detection</p>
                </div>

                <!-- Add Criminal -->
                <a href="{{ url_for('add_person') }}" class="action-box">
                    <div class="action-icon" style="color: #ea580c;">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <h3>Add Criminal</h3>
                    <p>Register new criminal</p>
                </a>

                <!-- Add Missing -->
                <a href="{{ url_for('add_missing_person') }}" class="action-box">
                    <div class="action-icon" style="color: #059669;">
                        <i class="fas fa-person-circle-question"></i>
                    </div>
                    <h3>Add Missing</h3>
                    <p>Report missing person</p>
                </a>
            </div>
        </div>

        <!-- RIGHT PANEL: Results -->
        <div class="results-panel">
            <!-- Match Results (Surveillance + Manual Search) -->
            <div class="results-card">
                <div class="panel-header">
                    <h2><i class="fas fa-list-alt"></i> Recognition Results</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn-dashboard btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="refreshSurveillanceResults()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn-dashboard btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="exportResults()">
                            Export
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="dashboard-table">
                        <thead>
                            <tr>
                                <th>Photo</th>
                                <th>Name</th>
                                <th>Match %</th>
                                <th>Source</th>
                                <th>Time</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: #9ca3af;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>
                                    Loading surveillance results...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="activity-card">
                <div class="panel-header">
                    <h2><i class="fas fa-history"></i> Recent Activity</h2>
                </div>
                <ul class="activity-list" id="activity-list">
                    <!-- Populated by JS -->
                    <li class="activity-item">
                        <span class="activity-time">Loading...</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Capture Modal -->
<div class="modal-backdrop" id="capture-modal">
    <div class="modal-content">
        <div class="panel-header">
            <h2>Capture Photo</h2>
            <button onclick="closeCaptureModal()" style="border:none; background:none; cursor:pointer; font-size:1.2rem;">&times;</button>
        </div>
        <div style="padding: 1.5rem; display: flex; flex-direction: column; align-items: center;">
            <video id="webcam-preview" style="width: 100%; max-width: 400px; border-radius: 0.5rem; background: black;" autoplay></video>
            <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                <button class="btn-dashboard btn-outline" onclick="closeCaptureModal()">Cancel</button>
                <button class="btn-dashboard btn-primary" onclick="capturePhoto()">Capture Frame</button>
            </div>
        </div>
    </div>
</div>

<!-- Crowd Detection Permission Modal -->
<div class="modal-backdrop" id="crowd-permission-modal" style="display:none;">
    <div class="modal-content" style="max-width: 450px;">
        <div class="panel-header" style="background: linear-gradient(135deg, #7c3aed, #5b21b6);">
            <h2 style="color: white;"><i class="fas fa-users"></i> Crowd Detection</h2>
            <button onclick="closeCrowdPermissionModal()" style="border:none; background:none; cursor:pointer; font-size:1.2rem; color:white;">&times;</button>
        </div>
        <div style="padding: 1.5rem;">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="width: 70px; height: 70px; background: #f3e8ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                    <i class="fas fa-video" style="font-size: 1.8rem; color: #7c3aed;"></i>
                </div>
                <h3 style="margin: 0 0 0.5rem; color: #1f2937;">Start Crowd Monitoring</h3>
                <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">
                    This will start the surveillance stream with crowd density analysis enabled.
                </p>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button onclick="closeCrowdPermissionModal()" class="btn-dashboard btn-outline" style="flex: 1;">
                    Cancel
                </button>
                <button onclick="startCrowdStream()" class="btn-dashboard btn-primary" style="flex: 1; background: #7c3aed;">
                    <i class="fas fa-play"></i> Start Stream
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Weapon Detection Permission Modal -->
<div class="modal-backdrop" id="weapon-permission-modal" style="display:none;">
    <div class="modal-content" style="max-width: 450px;">
        <div class="panel-header" style="background: linear-gradient(135deg, #b91c1c, #7f1d1d);">
            <h2 style="color: white;"><i class="fas fa-crosshairs"></i> Weapon Detection</h2>
            <button onclick="closeWeaponPermissionModal()" style="border:none; background:none; cursor:pointer; font-size:1.2rem; color:white;">&times;</button>
        </div>
        <div style="padding: 1.5rem;">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="width: 70px; height: 70px; background: #fef2f2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                    <i class="fas fa-shield-alt" style="font-size: 1.8rem; color: #b91c1c;"></i>
                </div>
                <h3 style="margin: 0 0 0.5rem; color: #1f2937;">Activate Threat Detection</h3>
                <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">
                    This will start the surveillance stream with YOLOv8 weapon detection enabled.
                </p>
            </div>

            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #92400e;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>AI Model: YOLOv8 (best.pt) will be loaded</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button onclick="closeWeaponPermissionModal()" class="btn-dashboard btn-outline" style="flex: 1;">
                    Cancel
                </button>
                <button onclick="startWeaponStream()" class="btn-dashboard btn-primary" style="flex: 1; background: #b91c1c;">
                    <i class="fas fa-power-off"></i> Activate
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Crowd Detection Functions
function requestCrowdDetectionPermission() {
    document.getElementById('crowd-permission-modal').style.display = 'flex';
}

function closeCrowdPermissionModal() {
    document.getElementById('crowd-permission-modal').style.display = 'none';
}

function startCrowdStream() {
    closeCrowdPermissionModal();
    window.location.href = '/crowd_detection';
}

// Weapon Detection Functions
function requestWeaponDetectionPermission() {
    document.getElementById('weapon-permission-modal').style.display = 'flex';
}

function closeWeaponPermissionModal() {
    document.getElementById('weapon-permission-modal').style.display = 'none';
}

function startWeaponStream() {
    closeWeaponPermissionModal();
    window.location.href = '/weapon_detection';
}
</script>

<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
