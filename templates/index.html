{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block header_actions %}
    <!-- Top Bar Actions -->
    <button class="btn-circle-add" onclick="openCaptureModal()" title="Live Camera">
        <i class="fas fa-camera"></i>
    </button>
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">

<div class="dashboard-container">
    <!-- 1. Info Header -->
    <div class="dashboard-header-info">
        <div class="station-info">
            <h1>TRINETRA - FACE RECOGNITION SYSTEM</h1>
            <div style="font-size: 0.85rem; color: #6b7280; margin-top: 0.25rem;">
                <i class="fas fa-building"></i> Station: Vile Parle PS &nbsp;|&nbsp; 
                <i class="fas fa-user-shield"></i> Officer: {{ current_user.username }}
            </div>
        </div>
        <div class="system-status">
            <div class="status-badge">
                <div id="camera-status" class="status-dot active blink"></div> Camera
            </div>
            <div class="status-badge">
                <div id="model-status" class="status-dot active"></div> ArcFace
            </div>
            <div class="status-badge">
                <div id="sync-status" class="status-dot active"></div> Sync: <span id="system-time">--:--</span>
            </div>
        </div>
    </div>

    <!-- 2. Split Layout -->
    <div class="dashboard-grid">
        <!-- LEFT PANEL: Quick Actions -->
        <div class="query-panel">
            <div class="panel-header">
                <h2><i class="fas fa-th-large"></i> Quick Actions</h2>
            </div>
            <div class="quick-actions-grid">
                <!-- Wanted Criminal Detection -->
                <a href="{{ url_for('add_wanted_criminal') }}" class="action-box">
                    <div class="action-icon" style="color: #D32F2F;">
                        <i class="fas fa-crosshairs"></i>
                    </div>
                    <h3>Wanted Detection</h3>
                    <p>Add priority 1 criminal</p>
                </a>

                <!-- Criminal Surveillance -->
                <a href="{{ url_for('surveillance_view', db_type='criminal') }}" class="action-box">
                    <div class="action-icon" style="color: #dc2626;">
                        <i class="fas fa-user-secret"></i>
                    </div>
                    <h3>Criminal Surveillance</h3>
                    <p>Monitor active criminals</p>
                </a>

                <!-- Missing Person Surveillance -->
                <a href="{{ url_for('surveillance_view', db_type='missing') }}" class="action-box">
                    <div class="action-icon" style="color: #0891b2;">
                        <i class="fas fa-search-location"></i>
                    </div>
                    <h3>Missing Surveillance</h3>
                    <p>Track missing persons</p>
                </a>

                <!-- Crowd Detection -->
                <div class="action-box" onclick="requestCrowdDetectionPermission()" id="crowd-detection-box">
                    <div class="action-icon" style="color: #7c3aed;">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3>Crowd Detection</h3>
                    <p>Monitor crowd density</p>
                    <span id="crowd-status-badge" style="display:none; position:absolute; top:8px; right:8px; background:#ef4444; color:white; padding:2px 6px; border-radius:10px; font-size:0.65rem;">LIVE</span>
                </div>

                <!-- Add Criminal -->
                <a href="{{ url_for('add_person') }}" class="action-box">
                    <div class="action-icon" style="color: #ea580c;">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <h3>Add Criminal</h3>
                    <p>Register new criminal</p>
                </a>

                <!-- Add Missing -->
                <a href="{{ url_for('add_missing_person') }}" class="action-box">
                    <div class="action-icon" style="color: #059669;">
                        <i class="fas fa-person-circle-question"></i>
                    </div>
                    <h3>Add Missing</h3>
                    <p>Report missing person</p>
                </a>
            </div>
        </div>

        <!-- RIGHT PANEL: Results -->
        <div class="results-panel">
            <!-- Match Results (Surveillance + Manual Search) -->
            <div class="results-card">
                <div class="panel-header">
                    <h2><i class="fas fa-list-alt"></i> Recognition Results</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn-dashboard btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="refreshSurveillanceResults()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn-dashboard btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="exportResults()">
                            Export
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="dashboard-table">
                        <thead>
                            <tr>
                                <th>Photo</th>
                                <th>Name</th>
                                <th>Match %</th>
                                <th>Source</th>
                                <th>Time</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: #9ca3af;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>
                                    Loading surveillance results...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="activity-card">
                <div class="panel-header">
                    <h2><i class="fas fa-history"></i> Recent Activity</h2>
                </div>
                <ul class="activity-list" id="activity-list">
                    <!-- Populated by JS -->
                    <li class="activity-item">
                        <span class="activity-time">Loading...</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Capture Modal -->
<div class="modal-backdrop" id="capture-modal">
    <div class="modal-content">
        <div class="panel-header">
            <h2>Capture Photo</h2>
            <button onclick="closeCaptureModal()" style="border:none; background:none; cursor:pointer; font-size:1.2rem;">&times;</button>
        </div>
        <div style="padding: 1.5rem; display: flex; flex-direction: column; align-items: center;">
            <video id="webcam-preview" style="width: 100%; max-width: 400px; border-radius: 0.5rem; background: black;" autoplay></video>
            <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                <button class="btn-dashboard btn-outline" onclick="closeCaptureModal()">Cancel</button>
                <button class="btn-dashboard btn-primary" onclick="capturePhoto()">Capture Frame</button>
            </div>
        </div>
    </div>
</div>

<!-- Crowd Detection Permission Modal -->
<div class="modal-backdrop" id="crowd-permission-modal" style="display:none;">
    <div class="modal-content" style="max-width: 480px;">
        <div class="panel-header" style="background: linear-gradient(135deg, #7c3aed, #5b21b6);">
            <h2 style="color: white;"><i class="fas fa-users"></i> Crowd Detection System</h2>
            <button onclick="closeCrowdPermissionModal()" style="border:none; background:none; cursor:pointer; font-size:1.2rem; color:white;">&times;</button>
        </div>
        <div style="padding: 1.5rem;">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="width: 80px; height: 80px; background: #f3e8ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                    <i class="fas fa-network-wired" style="font-size: 2rem; color: #7c3aed;"></i>
                </div>
                <h3 style="margin: 0 0 0.5rem; color: #1f2937;">Connect to Surveillance Network</h3>
                <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">
                    This will connect to the CCTV surveillance cameras for real-time crowd density monitoring.
                </p>
            </div>
            
            <div style="background: #ede9fe; border: 1px solid #7c3aed; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <i class="fas fa-info-circle" style="color: #7c3aed; margin-top: 2px;"></i>
                    <div style="font-size: 0.85rem; color: #5b21b6;">
                        <strong>System Access:</strong>
                        <ul style="margin: 0.5rem 0 0 1rem; padding: 0;">
                            <li>CCTV Network: 4 cameras in Vile Parle area</li>
                            <li>AI Crowd Analysis Engine</li>
                            <li>Real-time Alert System</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #166534;">
                    <i class="fas fa-shield-alt"></i>
                    <span>Authorized access for Vile Parle PS officers only</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button onclick="closeCrowdPermissionModal()" class="btn-dashboard btn-outline" style="flex: 1;">
                    Cancel
                </button>
                <button onclick="grantCrowdPermissions()" class="btn-dashboard btn-primary" style="flex: 1; background: #7c3aed;">
                    <i class="fas fa-plug"></i> Connect Now
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Crowd Detection Initializing Modal -->
<div class="modal-backdrop" id="crowd-init-modal" style="display:none;">
    <div class="modal-content" style="max-width: 400px;">
        <div style="padding: 2rem; text-align: center;">
            <div class="crowd-init-animation" style="margin-bottom: 1.5rem;">
                <i class="fas fa-satellite-dish fa-spin" style="font-size: 3rem; color: #7c3aed;"></i>
            </div>
            <h3 style="margin: 0 0 0.5rem; color: #1f2937;">Connecting to CCTV Network</h3>
            <p style="color: #6b7280; font-size: 0.9rem; margin: 0 0 1rem;">
                <span id="init-status">Establishing secure connection...</span>
            </p>
            <div style="width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
                <div id="init-progress" style="width: 0%; height: 100%; background: #7c3aed; transition: width 0.3s;"></div>
            </div>
        </div>
    </div>
</div>

<script>
// Crowd Detection Functions
let crowdDetectionActive = false;

function requestCrowdDetectionPermission() {
    document.getElementById('crowd-permission-modal').style.display = 'flex';
}

function closeCrowdPermissionModal() {
    document.getElementById('crowd-permission-modal').style.display = 'none';
}

function grantCrowdPermissions() {
    closeCrowdPermissionModal();
    // No need for actual permissions - using surveillance cameras
    startCrowdDetectionInit();
}

function startCrowdDetectionInit() {
    document.getElementById('crowd-init-modal').style.display = 'flex';
    
    const progress = document.getElementById('init-progress');
    const status = document.getElementById('init-status');
    
    const steps = [
        { text: 'Establishing secure connection...', progress: 15 },
        { text: 'Authenticating with CCTV network...', progress: 30 },
        { text: 'Connecting to Camera 1: Main Gate...', progress: 45 },
        { text: 'Connecting to Camera 2: Vile Parle Market...', progress: 55 },
        { text: 'Connecting to Camera 3: Station West...', progress: 65 },
        { text: 'Connecting to Camera 4: SV Road Junction...', progress: 75 },
        { text: 'Loading AI crowd analysis model...', progress: 90 },
        { text: 'Starting real-time monitoring...', progress: 100 }
    ];
    
    let step = 0;
    const interval = setInterval(() => {
        if (step < steps.length) {
            status.textContent = steps[step].text;
            progress.style.width = steps[step].progress + '%';
            step++;
        } else {
            clearInterval(interval);
            crowdDetectionActive = true;
            
            // Show LIVE badge
            document.getElementById('crowd-status-badge').style.display = 'block';
            document.getElementById('crowd-detection-box').style.position = 'relative';
            
            setTimeout(() => {
                document.getElementById('crowd-init-modal').style.display = 'none';
                window.location.href = '/crowd_detection';
            }, 500);
        }
    }, 600);
}
</script>

<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
