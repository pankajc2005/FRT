{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block header_actions %}
    <!-- Top Bar Actions (Search, etc) -->
    <div class="search-container" style="margin-right: 1rem;">
        <input type="text" id="dashboard-search" placeholder="Search Database..." 
               style="padding: 0.5rem 1rem; border-radius: 2rem; border: 1px solid #e5e7eb; width: 250px;">
    </div>
    <a href="{{ url_for('add_wanted_criminal') }}" class="btn-circle-add" title="Wanted Criminal Detection" 
       style="background: #D32F2F; margin-right: 0.5rem;">
        <i class="fas fa-crosshairs"></i>
    </a>
    <button class="btn-circle-add" onclick="openCaptureModal()" title="Live Camera">
        <i class="fas fa-camera"></i>
    </button>
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">

<div class="dashboard-container">
    <!-- 1. Info Header -->
    <div class="dashboard-header-info">
        <div class="station-info">
            <h1>TRINETRA - FACE RECOGNITION SYSTEM</h1>
            <div style="font-size: 0.85rem; color: #6b7280; margin-top: 0.25rem;">
                <i class="fas fa-building"></i> Station: Kochi City PS &nbsp;|&nbsp; 
                <i class="fas fa-user-shield"></i> Officer: {{ current_user.username }}
            </div>
        </div>
        <div class="system-status">
            <div class="status-badge">
                <div id="camera-status" class="status-dot active blink"></div> Camera
            </div>
            <div class="status-badge">
                <div id="model-status" class="status-dot active"></div> ArcFace
            </div>
            <div class="status-badge">
                <div id="sync-status" class="status-dot active"></div> Sync: <span id="system-time">--:--</span>
            </div>
        </div>
    </div>

    <!-- 2. Split Layout -->
    <div class="dashboard-grid">
        <!-- LEFT PANEL: Query -->
        <div class="query-panel">
            <div class="panel-header">
                <h2><i class="fas fa-search"></i> Current Query</h2>
                <span class="risk-badge risk-low">Ready</span>
            </div>
            <div class="query-content">
                <div class="face-preview-container">
                    <div class="face-placeholder">
                        <i class="fas fa-user-circle"></i>
                        <p>Waiting for Input...</p>
                    </div>
                    <!-- Image will be injected here -->
                </div>

                <div class="query-details">
                    <div class="detail-row">
                        <span class="detail-label">Query ID:</span>
                        <span class="detail-value">TRN-1234</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Source:</span>
                        <span class="detail-value">Live Feed</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Time:</span>
                        <span class="detail-value" id="query-time">--:--</span>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn-dashboard btn-primary" onclick="openCaptureModal()">
                        <i class="fas fa-camera"></i> Capture
                    </button>
                    <button class="btn-dashboard btn-outline" onclick="document.getElementById('file-upload').click()">
                        <i class="fas fa-upload"></i> Upload
                    </button>
                    <input type="file" id="file-upload" hidden accept="image/*">
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: Results -->
        <div class="results-panel">
            <!-- Match Results -->
            <div class="results-card">
                <div class="panel-header">
                    <h2><i class="fas fa-list-alt"></i> Match Results</h2>
                    <button class="btn-dashboard btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="exportResults()">
                        Export Report
                    </button>
                </div>
                <div class="table-container">
                    <table class="dashboard-table">
                        <thead>
                            <tr>
                                <th>Photo</th>
                                <th>Name</th>
                                <th>Match %</th>
                                <th>Risk</th>
                                <th>Details</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: #9ca3af;">
                                    <i class="fas fa-camera" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>
                                    Capture or upload a photo to search the database.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="activity-card">
                <div class="panel-header">
                    <h2><i class="fas fa-history"></i> Recent Activity</h2>
                </div>
                <ul class="activity-list" id="activity-list">
                    <!-- Populated by JS -->
                    <li class="activity-item">
                        <span class="activity-time">Loading...</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Capture Modal -->
<div class="modal-backdrop" id="capture-modal">
    <div class="modal-content">
        <div class="panel-header">
            <h2>Capture Photo</h2>
            <button onclick="closeCaptureModal()" style="border:none; background:none; cursor:pointer; font-size:1.2rem;">&times;</button>
        </div>
        <div style="padding: 1.5rem; display: flex; flex-direction: column; align-items: center;">
            <video id="webcam-preview" style="width: 100%; max-width: 400px; border-radius: 0.5rem; background: black;" autoplay></video>
            <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                <button class="btn-dashboard btn-outline" onclick="closeCaptureModal()">Cancel</button>
                <button class="btn-dashboard btn-primary" onclick="capturePhoto()">Capture Frame</button>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
