{% extends "layout.html" %}

{% block title %}Alert Details{% endblock %}

{% block content %}
<div class="view-container" style="padding: 20px;">
    <div class="header-section" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="{{ url_for('alerts_dashboard') }}" style="color: #666; font-size: 1.2rem;"><i class="fas fa-arrow-left"></i></a>
            <h1 style="margin: 0;">{{ alert.name }}</h1>
        </div>
        <span style="padding: 5px 15px; border-radius: 20px; color: white; font-weight: bold; background-color: {% if alert.db_type == 'criminal' %}#d32f2f{% else %}#f57c00{% endif %};">
            {{ alert.db_type|upper }}
        </span>
    </div>

    <div class="details-grid" style="display: grid; grid-template-columns: 300px 1fr; gap: 20px;">
        <!-- Left Column: Original Profile -->
        <div class="profile-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); height: fit-content;">
            <h3 style="margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #333;">Original Profile</h3>
            <div style="width: 100%; aspect-ratio: 1; overflow: hidden; border-radius: 8px; margin-bottom: 15px; background: #f5f5f5;">
                <img src="{{ url_for('serve_image', filename=alert.image_filename) }}" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            
            <div class="info-row" style="margin-bottom: 10px;">
                <label style="display: block; color: #888; font-size: 0.8rem;">ID</label>
                <div style="font-weight: 500;">{{ alert.id }}</div>
            </div>
            
            <div class="info-row" style="margin-bottom: 10px;">
                <label style="display: block; color: #888; font-size: 0.8rem;">Phone</label>
                <div style="font-weight: 500;">{{ alert.phone or alert.guardian_phone or '-' }}</div>
            </div>
            
            <div class="info-row" style="margin-bottom: 10px;">
                <label style="display: block; color: #888; font-size: 0.8rem;">Aadhaar</label>
                <div style="font-weight: 500;">{{ alert.aadhaar or alert.missing_aadhaar or '-' }}</div>
            </div>
            
            <div class="info-row" style="margin-bottom: 10px;">
                <label style="display: block; color: #888; font-size: 0.8rem;">Gender</label>
                <div style="font-weight: 500;">{{ alert.submitted_gender or alert.predicted_gender or '-' }}</div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                <a href="{{ url_for('view_person', person_id=alert.id) }}" class="btn btn-primary" style="width: 100%; text-align: center; display: block; text-decoration: none;">
                    <i class="fas fa-external-link-alt"></i> View in {{ alert.db_type|title }} DB
                </a>
            </div>
        </div>

        <!-- Right Column: Detection History -->
        <div class="history-section" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #333;">Detection History</h3>
                <div style="background: #e8f5e9; color: #2e7d32; padding: 5px 10px; border-radius: 4px; font-weight: bold;">
                    Best Match: {{ alert.best_match_percentage }}%
                </div>
            </div>
            
            <div class="timeline">
                {% for detection in alert.detections|sort(attribute='match_percentage', reverse=True) %}
                <div class="detection-item" style="display: flex; gap: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 15px; transition: transform 0.2s;">
                    <div class="detection-img" style="width: 150px; height: 150px; flex-shrink: 0; background: #000; border-radius: 4px; overflow: hidden;">
                        <img src="{{ url_for('serve_alert_image', filename=detection.capture_frame) }}" style="width: 100%; height: 100%; object-fit: contain; cursor: pointer;" onclick="window.open(this.src, '_blank')">
                    </div>
                    <div class="detection-info" style="flex-grow: 1;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #2e7d32; font-size: 1.1rem;">Match Confidence: {{ detection.match_percentage }}%</h4>
                            <span style="color: #888; font-size: 0.9rem;">{{ detection.timestamp.split('T')[0] }} {{ detection.timestamp.split('T')[1][:8] }}</span>
                        </div>
                        <p style="color: #555; margin-bottom: 10px;">Detected during surveillance scan.</p>
                        <div style="display: flex; gap: 10px;">
                            <a href="{{ url_for('serve_alert_image', filename=detection.capture_frame) }}" target="_blank" class="btn btn-sm" style="background: #eee; color: #333; text-decoration: none; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem;">
                                <i class="fas fa-expand"></i> View Full Image
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}