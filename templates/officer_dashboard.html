{% extends "layout.html" %}

{% block title %}Officer Portal{% endblock %}
{% block page_title %}Officer Portal{% endblock %}

{% block content %}
<style>
    .officer-container {
        max-width: 500px;
        margin: 0 auto;
        padding: 0 15px;
    }
    
    .welcome-card {
        background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
        color: white;
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .welcome-card h1 {
        font-size: 1.4rem;
        margin: 0 0 8px 0;
    }
    
    .welcome-card p {
        opacity: 0.9;
        margin: 0;
        font-size: 0.85rem;
    }
    
    .action-cards {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 25px;
    }
    
    .action-card {
        background: white;
        border-radius: 16px;
        padding: 25px 20px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
    }
    
    .action-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.12);
    }
    
    .action-card.active {
        border-color: #1e40af;
        background: #eff6ff;
    }
    
    .action-card i {
        font-size: 2.5rem;
        margin-bottom: 12px;
        display: block;
    }
    
    .action-card.search i { color: #1e40af; }
    .action-card.alerts i { color: #dc2626; }
    
    .action-card h3 {
        font-size: 1rem;
        color: #1f2937;
        margin: 0 0 5px 0;
    }
    
    .action-card p {
        font-size: 0.8rem;
        color: #6b7280;
        margin: 0;
    }
    
    /* Search Section */
    .search-section {
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        margin-bottom: 20px;
        display: none;
    }
    
    .search-section.show {
        display: block;
    }
    
    .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .db-select {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
    }
    
    .db-select button {
        flex: 1;
        padding: 12px 8px;
        border: 2px solid #e5e7eb;
        background: white;
        border-radius: 10px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
    }
    
    .db-select button.active {
        border-color: #1e40af;
        background: #eff6ff;
        color: #1e40af;
    }
    
    .photo-options {
        display: flex;
        gap: 12px;
    }
    
    .photo-btn {
        flex: 1;
        padding: 18px 15px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
    }
    
    .photo-btn i {
        font-size: 1.8rem;
    }
    
    .photo-btn.camera {
        background: linear-gradient(135deg, #16a34a, #15803d);
        color: white;
    }
    
    .photo-btn.gallery {
        background: linear-gradient(135deg, #1e40af, #1e3a8a);
        color: white;
    }
    
    .photo-btn:active {
        transform: scale(0.98);
    }
    
    /* Alerts Section */
    .alerts-section {
        display: none;
    }
    
    .alerts-section.show {
        display: block;
    }
    
    .alert-card {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .alert-card img {
        width: 60px;
        height: 60px;
        border-radius: 10px;
        object-fit: cover;
    }
    
    .alert-card .alert-info {
        flex: 1;
    }
    
    .alert-card .alert-info h4 {
        margin: 0 0 5px 0;
        font-size: 1rem;
        color: #1f2937;
    }
    
    .alert-card .alert-info p {
        margin: 0;
        font-size: 0.85rem;
        color: #6b7280;
    }
    
    .alert-priority {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .priority-1 { background: #dc2626; color: white; }
    .priority-2 { background: #f97316; color: white; }
    .priority-3 { background: #eab308; color: #1f2937; }
    
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    
    .modal-content {
        background: white;
        border-radius: 20px;
        width: 100%;
        max-width: 400px;
        max-height: 90vh;
        overflow-y: auto;
        animation: modalSlide 0.3s ease;
    }
    
    @keyframes modalSlide {
        from { transform: translateY(50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    .processing-modal {
        padding: 40px 30px;
        text-align: center;
    }
    
    .processing-modal .spinner {
        width: 60px;
        height: 60px;
        border: 4px solid #e5e7eb;
        border-top-color: #1e40af;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .processing-modal h3 {
        margin: 0 0 10px 0;
        color: #1f2937;
    }
    
    .processing-modal p {
        margin: 0;
        color: #6b7280;
    }
    
    /* Result Modal */
    .result-modal .modal-header {
        padding: 20px;
        text-align: center;
        border-radius: 20px 20px 0 0;
    }
    
    .result-modal .modal-header.match {
        background: linear-gradient(135deg, #16a34a, #15803d);
        color: white;
    }
    
    .result-modal .modal-header.no-match {
        background: linear-gradient(135deg, #6b7280, #4b5563);
        color: white;
    }
    
    .result-modal .modal-header.wanted {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        color: white;
    }
    
    .result-modal .modal-header i {
        font-size: 2.5rem;
        margin-bottom: 10px;
    }
    
    .result-modal .modal-header h3 {
        margin: 0;
        font-size: 1.2rem;
    }
    
    .result-modal .modal-body {
        padding: 20px;
    }
    
    .person-card {
        display: flex;
        gap: 15px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 12px;
        margin-bottom: 15px;
    }
    
    .person-card img {
        width: 80px;
        height: 80px;
        border-radius: 12px;
        object-fit: cover;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .person-card .info h4 {
        margin: 0 0 8px 0;
        font-size: 1.1rem;
    }
    
    .person-card .badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 600;
        margin-right: 5px;
    }
    
    .badge.criminal { background: #fef2f2; color: #dc2626; }
    .badge.missing { background: #eff6ff; color: #1e40af; }
    .badge.wanted { background: #dc2626; color: white; }
    
    .details-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .detail-item {
        background: #f8fafc;
        padding: 12px;
        border-radius: 10px;
    }
    
    .detail-item label {
        display: block;
        font-size: 0.75rem;
        color: #6b7280;
        margin-bottom: 4px;
    }
    
    .detail-item span {
        font-weight: 600;
        color: #1f2937;
    }
    
    .modal-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .btn-report {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    
    .btn-close-modal {
        width: 100%;
        padding: 14px;
        background: #6b7280;
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
    }
    
    /* Report Form */
    .report-form {
        padding: 20px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #374151;
        font-size: 0.9rem;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 0.95rem;
        box-sizing: border-box;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        border-color: #1e40af;
        outline: none;
    }
    
    .btn-gps {
        margin-top: 8px;
        padding: 10px 15px;
        background: #1e40af;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85rem;
        width: 100%;
    }
    
    .report-footer {
        display: flex;
        gap: 10px;
        padding: 15px 20px;
        background: #f8fafc;
        border-radius: 0 0 20px 20px;
    }
    
    .report-footer button {
        flex: 1;
        padding: 14px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
    }
    
    .btn-cancel {
        background: #6b7280;
        color: white;
    }
    
    .btn-submit {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        color: white;
    }
    
    .btn-submit:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }
    
    /* Success Modal */
    .success-modal {
        padding: 40px 30px;
        text-align: center;
    }
    
    .success-modal i {
        font-size: 4rem;
        color: #16a34a;
        margin-bottom: 15px;
    }
    
    .success-modal h3 {
        margin: 0 0 10px 0;
        color: #166534;
    }
    
    .success-modal p {
        margin: 0 0 25px 0;
        color: #15803d;
    }
    
    .success-modal button {
        padding: 14px 40px;
        background: #16a34a;
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
    }
    
    /* Mobile */
    @media (max-width: 400px) {
        .officer-container {
            padding: 0 10px;
        }
        .action-card {
            padding: 20px 15px;
        }
        .photo-btn {
            padding: 15px 10px;
        }
    }
</style>

<div class="officer-container">
    <!-- Welcome Card -->
    <div class="welcome-card">
        <h1><i class="fas fa-shield-alt"></i> Officer Portal</h1>
        <p>Field Operations - Photo Search & Alerts</p>
    </div>
    
    <!-- Action Cards -->
    <div class="action-cards">
        <div class="action-card search" onclick="showSection('search')">
            <i class="fas fa-camera"></i>
            <h3>Photo Search</h3>
            <p>Scan & identify</p>
        </div>
        <div class="action-card alerts" onclick="showSection('alerts')">
            <i class="fas fa-bell"></i>
            <h3>View Alerts</h3>
            <p>Active alerts</p>
        </div>
    </div>
    
    <!-- Photo Search Section -->
    <div id="search-section" class="search-section">
        <div class="section-title">
            <i class="fas fa-search"></i> Search Database
        </div>
        
        <div class="db-select">
            <button id="db-criminal" class="active" onclick="selectDB('criminal')">
                <i class="fas fa-user-secret"></i> Criminal
            </button>
            <button id="db-missing" onclick="selectDB('missing')">
                <i class="fas fa-user-clock"></i> Missing
            </button>
            <button id="db-both" onclick="selectDB('both')">
                <i class="fas fa-users"></i> Both
            </button>
        </div>
        
        <div class="photo-options">
            <button class="photo-btn camera" onclick="takePhoto()">
                <i class="fas fa-camera"></i>
                Take Photo
            </button>
            <button class="photo-btn gallery" onclick="selectFromGallery()">
                <i class="fas fa-images"></i>
                Gallery
            </button>
        </div>
        
        <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none" onchange="handleFileSelect(this)">
        <input type="file" id="gallery-input" accept="image/*" style="display:none" onchange="handleFileSelect(this)">
    </div>
    
    <!-- Alerts Section -->
    <div id="alerts-section" class="alerts-section">
        <div class="search-section show">
            <div class="section-title" style="justify-content: space-between;">
                <span><i class="fas fa-bell"></i> Active Alerts</span>
                <button onclick="loadAlerts()" style="padding: 8px 15px; background: #1e40af; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.8rem;">
                    <i class="fas fa-sync"></i>
                </button>
            </div>
            <div id="alerts-list">
                <!-- Alerts will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Modal Container -->
<div id="modal-container"></div>

<script>
let selectedDB = 'criminal';
let lastMatchData = null;

function showSection(section) {
    document.querySelectorAll('.action-card').forEach(c => c.classList.remove('active'));
    document.querySelector('.action-card.' + section).classList.add('active');
    
    document.getElementById('search-section').classList.toggle('show', section === 'search');
    document.getElementById('alerts-section').classList.toggle('show', section === 'alerts');
    
    if (section === 'alerts') {
        loadAlerts();
    }
}

function selectDB(db) {
    selectedDB = db;
    document.querySelectorAll('.db-select button').forEach(b => b.classList.remove('active'));
    document.getElementById('db-' + db).classList.add('active');
}

function takePhoto() {
    document.getElementById('camera-input').click();
}

function selectFromGallery() {
    document.getElementById('gallery-input').click();
}

function handleFileSelect(input) {
    if (!input.files || !input.files[0]) return;
    
    const file = input.files[0];
    showProcessingModal();
    
    const formData = new FormData();
    formData.append('image', file);
    formData.append('camera_type', input.id === 'camera-input' ? 'camera' : 'gallery');
    formData.append('search_db', selectedDB);
    
    fetch('/api/officer/photo_search', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideModal();
        if (data.error) {
            showResultModal(null, data.error);
        } else if (data.match) {
            showResultModal(data.person, null, data.confidence, data.captured_image);
        } else {
            showResultModal(null, 'No match found in database');
        }
    })
    .catch(err => {
        console.error('Search error:', err);
        hideModal();
        showResultModal(null, 'Search failed. Please try again.');
    });
    
    // Reset input
    input.value = '';
}

function showProcessingModal() {
    document.getElementById('modal-container').innerHTML = `
        <div class="modal-overlay" id="processing-modal">
            <div class="modal-content">
                <div class="processing-modal">
                    <div class="spinner"></div>
                    <h3>Processing...</h3>
                    <p>Searching database for matches</p>
                </div>
            </div>
        </div>
    `;
}

function hideModal() {
    document.getElementById('modal-container').innerHTML = '';
}

function showResultModal(person, error, confidence, capturedImage) {
    if (error) {
        document.getElementById('modal-container').innerHTML = `
            <div class="modal-overlay">
                <div class="modal-content result-modal">
                    <div class="modal-header no-match">
                        <i class="fas fa-user-slash"></i>
                        <h3>No Match Found</h3>
                    </div>
                    <div class="modal-body">
                        <div class="empty-state">
                            <p>${error}</p>
                        </div>
                        <div class="modal-actions">
                            <button class="btn-close-modal" onclick="hideModal()">
                                <i class="fas fa-search"></i> New Search
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        lastMatchData = { person, confidence, capturedImage, timestamp: new Date().toISOString() };
        const isWanted = person.is_wanted;
        const dbType = person.db_type;
        
        document.getElementById('modal-container').innerHTML = `
            <div class="modal-overlay">
                <div class="modal-content result-modal">
                    <div class="modal-header ${isWanted ? 'wanted' : 'match'}">
                        <i class="fas fa-${isWanted ? 'exclamation-triangle' : 'user-check'}"></i>
                        <h3>${isWanted ? '‚ö†Ô∏è WANTED PERSON' : 'Match Found!'}</h3>
                    </div>
                    <div class="modal-body">
                        <!-- Comparison: Captured vs Database -->
                        <div style="display: flex; gap: 10px; margin-bottom: 15px; background: #f1f5f9; padding: 12px; border-radius: 12px;">
                            <div style="flex: 1; text-align: center;">
                                <img src="/data/images/${capturedImage}" alt="Captured" style="width: 70px; height: 70px; border-radius: 10px; object-fit: cover; border: 3px solid #f97316;" onerror="this.src='https://via.placeholder.com/70?text=Captured'">
                                <p style="margin: 5px 0 0; font-size: 0.7rem; color: #6b7280;">üì∑ Captured</p>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <i class="fas fa-arrows-alt-h" style="color: #16a34a; font-size: 1.5rem;"></i>
                            </div>
                            <div style="flex: 1; text-align: center;">
                                <img src="/data/images/${person.image_filename}" alt="${person.name}" style="width: 70px; height: 70px; border-radius: 10px; object-fit: cover; border: 3px solid #16a34a;" onerror="this.src='https://via.placeholder.com/70?text=Database'">
                                <p style="margin: 5px 0 0; font-size: 0.7rem; color: #6b7280;">üóÑÔ∏è Database</p>
                            </div>
                        </div>
                        
                        <div class="person-card">
                            <img src="/data/images/${person.image_filename}" alt="${person.name}" onerror="this.src='https://via.placeholder.com/80?text=No+Image'">
                            <div class="info">
                                <h4>${person.name}</h4>
                                <span class="badge ${dbType}">${dbType.toUpperCase()}</span>
                                ${isWanted ? '<span class="badge wanted">WANTED</span>' : ''}
                            </div>
                        </div>
                        
                        <div class="details-grid">
                            <div class="detail-item">
                                <label>Confidence</label>
                                <span>${confidence}%</span>
                            </div>
                            <div class="detail-item">
                                <label>Priority</label>
                                <span>Level ${person.priority}</span>
                            </div>
                            <div class="detail-item">
                                <label>Database</label>
                                <span>${dbType === 'criminal' ? 'Criminal' : 'Missing'}</span>
                            </div>
                            <div class="detail-item">
                                <label>ID</label>
                                <span style="font-size: 0.7rem;">${person.id.substring(0, 12)}...</span>
                            </div>
                        </div>
                        
                        <div class="modal-actions">
                            <button class="btn-report" onclick="showReportForm()">
                                <i class="fas fa-broadcast-tower"></i> Report to Control Room
                            </button>
                            <button class="btn-close-modal" onclick="hideModal()">
                                <i class="fas fa-search"></i> New Search
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
}

function showReportForm() {
    if (!lastMatchData) return;
    
    const isFromAlert = lastMatchData.fromAlert;
    const confidenceText = isFromAlert ? 'Visual Identification' : `${lastMatchData.confidence}% Match`;
    const backAction = isFromAlert ? 'hideModal()' : `showResultModal(lastMatchData.person, null, lastMatchData.confidence, lastMatchData.capturedImage)`;
    
    document.getElementById('modal-container').innerHTML = `
        <div class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header wanted" style="padding: 20px; border-radius: 20px 20px 0 0;">
                    <i class="fas fa-broadcast-tower" style="font-size: 1.5rem; margin-bottom: 5px;"></i>
                    <h3 style="margin: 0;">${isFromAlert ? 'Report Sighting' : 'Report to Control Room'}</h3>
                </div>
                
                <div class="report-form">
                    <div class="person-card">
                        <img src="/data/images/${lastMatchData.person.image_filename}" alt="${lastMatchData.person.name}" onerror="this.src='https://via.placeholder.com/80?text=No+Image'">
                        <div class="info">
                            <h4>${lastMatchData.person.name}</h4>
                            <span class="badge ${lastMatchData.person.db_type}">${lastMatchData.person.db_type.toUpperCase()}</span>
                            ${lastMatchData.person.is_wanted ? '<span class="badge wanted">WANTED</span>' : ''}
                            <p style="margin: 5px 0 0; font-size: 0.85rem; color: #6b7280;">${confidenceText}</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-map-marker-alt"></i> Current Location *</label>
                        <input type="text" id="report-location" placeholder="Enter location details" required>
                        <button type="button" class="btn-gps" onclick="getGPSLocation()">
                            <i class="fas fa-crosshairs"></i> Get GPS Location
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-comment-alt"></i> Situation Details</label>
                        <textarea id="report-details" rows="3" placeholder="Describe what you observed...">${isFromAlert ? 'Visual sighting of person from alert. ' : ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-exclamation-triangle"></i> Urgency Level</label>
                        <select id="report-urgency">
                            <option value="high" ${lastMatchData.person.is_wanted ? 'selected' : ''}>üî¥ High - Immediate Action</option>
                            <option value="medium" ${!lastMatchData.person.is_wanted ? 'selected' : ''}>üü° Medium - Attention Needed</option>
                            <option value="low">üü¢ Low - Information Only</option>
                        </select>
                    </div>
                </div>
                
                <div class="report-footer">
                    <button class="btn-cancel" onclick="${backAction}">
                        Back
                    </button>
                    <button class="btn-submit" id="btn-submit" onclick="submitReport()">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </div>
        </div>
    `;
}

function getGPSLocation() {
    const input = document.getElementById('report-location');
    input.value = 'Getting location...';
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                const lat = position.coords.latitude.toFixed(6);
                const lng = position.coords.longitude.toFixed(6);
                
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
                    const data = await response.json();
                    input.value = data.display_name ? data.display_name.substring(0, 100) : `GPS: ${lat}, ${lng}`;
                } catch (e) {
                    input.value = `GPS: ${lat}, ${lng}`;
                }
            },
            (error) => {
                input.value = '';
                alert('Could not get location. Please enter manually.');
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    } else {
        input.value = '';
        alert('Geolocation not supported');
    }
}

async function submitReport() {
    const location = document.getElementById('report-location').value.trim();
    const details = document.getElementById('report-details').value.trim();
    const urgency = document.getElementById('report-urgency').value;
    
    if (!location) {
        alert('Please enter a location');
        return;
    }
    
    const btn = document.getElementById('btn-submit');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    
    const isFromAlert = lastMatchData.fromAlert || false;
    
    try {
        const reportData = {
            person_id: lastMatchData.person.id,
            person_name: lastMatchData.person.name,
            person_image: lastMatchData.person.image_filename,
            captured_image: lastMatchData.capturedImage || null,
            db_type: lastMatchData.person.db_type,
            confidence: isFromAlert ? 'Visual ID' : lastMatchData.confidence,
            is_wanted: lastMatchData.person.is_wanted || false,
            priority: lastMatchData.person.priority || 3,
            location: location,
            details: details,
            urgency: urgency,
            search_timestamp: lastMatchData.timestamp,
            report_type: isFromAlert ? 'ALERT_SIGHTING' : 'PHOTO_MATCH'
        };
        
        console.log('Sending report:', reportData);
        
        const response = await fetch('/api/officer/report', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(reportData),
            credentials: 'same-origin'
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Error response:', errorText);
            throw new Error(`Server error: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
            showSuccessModal();
        } else {
            alert('Failed: ' + (data.error || 'Unknown error'));
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
        }
    } catch (err) {
        console.error('Report error:', err);
        alert('Failed to send report: ' + err.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
    }
}

function showSuccessModal() {
    document.getElementById('modal-container').innerHTML = `
        <div class="modal-overlay">
            <div class="modal-content">
                <div class="success-modal">
                    <i class="fas fa-check-circle"></i>
                    <h3>Report Sent!</h3>
                    <p>Control Room has been notified.</p>
                    <button onclick="hideModal()">
                        <i class="fas fa-thumbs-up"></i> Done
                    </button>
                </div>
            </div>
        </div>
    `;
    lastMatchData = null;
}

async function loadAlerts() {
    const alertsList = document.getElementById('alerts-list');
    alertsList.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></div>';
    
    try {
        const response = await fetch('/api/officer/alerts');
        const data = await response.json();
        
        if (data.alerts && data.alerts.length > 0) {
            let html = '';
            data.alerts.forEach(alert => {
                // Handle different alert types
                const alertType = alert.type || alert.db_type;
                
                // SOS Emergency Alert
                if (alertType === 'SOS_EMERGENCY') {
                    html += `
                        <div class="alert-card" style="cursor: pointer; border-left: 4px solid #dc2626; background: #fef2f2;" onclick="showSOSDetails('${alert.id}', '${alert.location || ''}', '${alert.map_link || ''}', '${alert.timestamp_ist || ''}')">
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #dc2626, #b91c1c); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-exclamation-triangle" style="color: white; font-size: 1.5rem;"></i>
                            </div>
                            <div class="alert-info">
                                <h4 style="color: #dc2626;">üö® SOS EMERGENCY</h4>
                                <p style="font-size: 0.75rem;">${alert.location ? alert.location.substring(0, 40) + '...' : 'Location available'}</p>
                            </div>
                            <span class="alert-priority priority-1">üî¥ Critical</span>
                        </div>
                    `;
                }
                // Incident Report
                else if (alertType === 'INCIDENT_REPORT') {
                    const severityClass = alert.priority === 1 ? 'priority-1' : (alert.priority === 2 ? 'priority-2' : 'priority-3');
                    const severityText = alert.priority === 1 ? 'üî¥ Critical' : (alert.priority === 2 ? 'üü† High' : 'üü° Medium');
                    html += `
                        <div class="alert-card" style="cursor: pointer; border-left: 4px solid #f59e0b; background: #fffbeb;" onclick="showIncidentDetails('${alert.id}', '${(alert.name || '').replace(/'/g, "\\'")}', '${(alert.location || '').replace(/'/g, "\\'")}', '${(alert.description || '').replace(/'/g, "\\'")}', '${alert.timestamp_ist || ''}')">
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-flag" style="color: white; font-size: 1.5rem;"></i>
                            </div>
                            <div class="alert-info">
                                <h4 style="color: #d97706;">üì¢ ${alert.name || 'Incident Report'}</h4>
                                <p style="font-size: 0.75rem;">${alert.location ? alert.location.substring(0, 40) : 'Location available'}</p>
                            </div>
                            <span class="alert-priority ${severityClass}">${severityText}</span>
                        </div>
                    `;
                }
                // Urgent Travel
                else if (alertType === 'URGENT_TRAVEL') {
                    html += `
                        <div class="alert-card" style="cursor: pointer; border-left: 4px solid #8b5cf6; background: #f5f3ff;" onclick="showUrgentTravelDetails('${alert.id}', '${(alert.start_location || '').replace(/'/g, "\\'")}', '${(alert.end_location || '').replace(/'/g, "\\'")}', '${alert.map_link || ''}', '${alert.timestamp_ist || ''}')">
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-car" style="color: white; font-size: 1.5rem;"></i>
                            </div>
                            <div class="alert-info">
                                <h4 style="color: #7c3aed;">üöó URGENT TRAVEL</h4>
                                <p style="font-size: 0.75rem;">Monitoring required</p>
                            </div>
                            <span class="alert-priority priority-2">üü† High</span>
                        </div>
                    `;
                }
                // Regular criminal/missing/wanted alerts
                else {
                    const priorityClass = 'priority-' + Math.min(alert.priority || 3, 3);
                    const priorityText = alert.priority === 1 ? 'üî¥ Critical' : (alert.priority === 2 ? 'üü† High' : 'üü° Medium');
                    const dbTypeLabel = alert.db_type === 'wanted' ? '‚ö†Ô∏è WANTED' : (alert.db_type === 'missing' ? 'üîç Missing' : 'üë§ Criminal');
                    const isWanted = alert.is_wanted || alert.db_type === 'wanted';
                    
                    html += `
                        <div class="alert-card" style="cursor: pointer; ${isWanted ? 'border-left: 4px solid #dc2626;' : ''}" onclick="showAlertDetails('${alert.id}', '${alert.name}', '${alert.image_filename}', '${alert.db_type}', ${alert.priority}, ${isWanted})">
                            <img src="/data/images/${alert.image_filename}" alt="${alert.name}" onerror="this.src='https://via.placeholder.com/60?text=?'">
                            <div class="alert-info">
                                <h4>${alert.name}</h4>
                                <p>${dbTypeLabel}</p>
                            </div>
                            <span class="alert-priority ${priorityClass}">${priorityText}</span>
                        </div>
                    `;
                }
            });
            alertsList.innerHTML = html;
        } else {
            alertsList.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle" style="color: #16a34a;"></i><p>No active alerts</p></div>';
        }
    } catch (err) {
        console.error('Error:', err);
        alertsList.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle" style="color: #dc2626;"></i><p>Failed to load</p></div>';
    }
}

// Show SOS Emergency Details
function showSOSDetails(id, location, mapLink, timestamp) {
    document.getElementById('modal-container').innerHTML = `
        <div class="modal-overlay">
            <div class="modal-content result-modal">
                <div class="modal-header wanted" style="padding: 20px; border-radius: 20px 20px 0 0; background: linear-gradient(135deg, #dc2626, #b91c1c);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 8px;"></i>
                    <h3 style="margin: 0;">üö® SOS EMERGENCY ALERT</h3>
                </div>
                <div class="modal-body" style="padding: 20px;">
                    <div style="background: #fef2f2; border: 2px solid #fecaca; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: #dc2626; margin: 0 0 10px 0;"><i class="fas fa-female"></i> Woman in Distress</h4>
                        <p style="margin: 0; color: #7f1d1d; font-size: 0.9rem;">Immediate response required!</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; color: #374151; font-size: 0.85rem;"><i class="fas fa-map-marker-alt"></i> Location:</label>
                        <p style="margin: 5px 0; padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 0.9rem;">${location || 'Location being determined...'}</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; color: #374151; font-size: 0.85rem;"><i class="fas fa-clock"></i> Reported At:</label>
                        <p style="margin: 5px 0; padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 0.9rem;">${timestamp || 'Just now'}</p>
                    </div>
                    
                    <div class="modal-actions" style="display: flex; flex-direction: column; gap: 10px;">
                        ${mapLink ? `<a href="${mapLink}" target="_blank" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #16a34a, #15803d); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; text-decoration: none;">
                            <i class="fas fa-directions"></i> Open in Maps
                        </a>` : ''}
                        <button onclick="acknowledgeAlert('${id}')" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #1e40af, #1e3a8a); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <i class="fas fa-check"></i> Acknowledge & Respond
                        </button>
                        <button class="btn-close-modal" onclick="hideModal()">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Show Incident Details
function showIncidentDetails(id, name, location, description, timestamp) {
    document.getElementById('modal-container').innerHTML = `
        <div class="modal-overlay">
            <div class="modal-content result-modal">
                <div class="modal-header" style="padding: 20px; border-radius: 20px 20px 0 0; background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                    <i class="fas fa-flag" style="font-size: 2rem; margin-bottom: 8px;"></i>
                    <h3 style="margin: 0;">üì¢ Incident Report</h3>
                </div>
                <div class="modal-body" style="padding: 20px;">
                    <div style="background: #fffbeb; border: 2px solid #fde68a; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                        <h4 style="color: #d97706; margin: 0 0 5px 0;">${name || 'Incident Reported'}</h4>
                        <p style="margin: 0; color: #92400e; font-size: 0.85rem;">Via Women Safety Portal</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; color: #374151; font-size: 0.85rem;"><i class="fas fa-map-marker-alt"></i> Location:</label>
                        <p style="margin: 5px 0; padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 0.9rem;">${location || 'Not specified'}</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; color: #374151; font-size: 0.85rem;"><i class="fas fa-comment-alt"></i> Description:</label>
                        <p style="margin: 5px 0; padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 0.9rem;">${description || 'No description provided'}</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; color: #374151; font-size: 0.85rem;"><i class="fas fa-clock"></i> Reported At:</label>
                        <p style="margin: 5px 0; padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 0.9rem;">${timestamp || 'Recently'}</p>
                    </div>
                    
                    <div class="modal-actions" style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="acknowledgeAlert('${id}')" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #16a34a, #15803d); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <i class="fas fa-check"></i> Acknowledge
                        </button>
                        <button class="btn-close-modal" onclick="hideModal()">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Show Urgent Travel Details
function showUrgentTravelDetails(id, startLoc, endLoc, mapLink, timestamp) {
    document.getElementById('modal-container').innerHTML = `
        <div class="modal-overlay">
            <div class="modal-content result-modal">
                <div class="modal-header" style="padding: 20px; border-radius: 20px 20px 0 0; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;">
                    <i class="fas fa-car" style="font-size: 2rem; margin-bottom: 8px;"></i>
                    <h3 style="margin: 0;">üöó Urgent Travel Alert</h3>
                </div>
                <div class="modal-body" style="padding: 20px;">
                    <div style="background: #f5f3ff; border: 2px solid #c4b5fd; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                        <p style="margin: 0; color: #5b21b6; font-size: 0.9rem;"><i class="fas fa-info-circle"></i> A woman has activated urgent travel mode and requires monitoring</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; color: #374151; font-size: 0.85rem;"><i class="fas fa-play-circle" style="color: #16a34a;"></i> From:</label>
                        <p style="margin: 5px 0; padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 0.9rem;">${startLoc || 'Start location'}</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; color: #374151; font-size: 0.85rem;"><i class="fas fa-stop-circle" style="color: #dc2626;"></i> To:</label>
                        <p style="margin: 5px 0; padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 0.9rem;">${endLoc || 'Destination'}</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; color: #374151; font-size: 0.85rem;"><i class="fas fa-clock"></i> Started At:</label>
                        <p style="margin: 5px 0; padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 0.9rem;">${timestamp || 'Just now'}</p>
                    </div>
                    
                    <div class="modal-actions" style="display: flex; flex-direction: column; gap: 10px;">
                        ${mapLink ? `<a href="${mapLink}" target="_blank" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #1e40af, #1e3a8a); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; text-decoration: none;">
                            <i class="fas fa-route"></i> View Route
                        </a>` : ''}
                        <button onclick="acknowledgeAlert('${id}')" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #16a34a, #15803d); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <i class="fas fa-eye"></i> Acknowledge & Monitor
                        </button>
                        <button class="btn-close-modal" onclick="hideModal()">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Acknowledge alert
async function acknowledgeAlert(alertId) {
    try {
        // In a real app, this would update the alert status on the server
        alert('Alert acknowledged! You are now assigned to respond.');
        hideModal();
        loadAlerts();
    } catch (err) {
        console.error('Error acknowledging alert:', err);
    }
}

// Show alert details modal
function showAlertDetails(id, name, image, dbType, priority, isWanted) {
    const dbLabel = dbType === 'wanted' ? 'WANTED CRIMINAL' : (dbType === 'missing' ? 'MISSING PERSON' : 'CRIMINAL');
    const headerClass = isWanted ? 'wanted' : (dbType === 'missing' ? 'no-match' : 'match');
    
    document.getElementById('modal-container').innerHTML = `
        <div class="modal-overlay">
            <div class="modal-content result-modal">
                <div class="modal-header ${headerClass}" style="padding: 20px; border-radius: 20px 20px 0 0;">
                    <i class="fas fa-${isWanted ? 'exclamation-triangle' : (dbType === 'missing' ? 'user-clock' : 'user-check')}" style="font-size: 2rem; margin-bottom: 8px;"></i>
                    <h3 style="margin: 0;">${isWanted ? '‚ö†Ô∏è ' : ''}${dbLabel}</h3>
                </div>
                <div class="modal-body">
                    <div class="person-card" style="justify-content: center;">
                        <img src="/data/images/${image}" alt="${name}" style="width: 100px; height: 100px;" onerror="this.src='https://via.placeholder.com/100?text=No+Image'">
                    </div>
                    <div style="text-align: center; margin: 15px 0;">
                        <h3 style="margin: 0 0 10px 0;">${name}</h3>
                        <span class="badge ${dbType}" style="padding: 5px 15px; font-size: 0.85rem;">${dbType.toUpperCase()}</span>
                        ${isWanted ? '<span class="badge wanted" style="padding: 5px 15px; font-size: 0.85rem; margin-left: 5px;">WANTED</span>' : ''}
                    </div>
                    
                    <div style="background: #fff7ed; border: 1px solid #fed7aa; padding: 15px; border-radius: 10px; margin: 15px 0; text-align: center;">
                        <i class="fas fa-info-circle" style="color: #ea580c;"></i>
                        <p style="margin: 8px 0 0; font-size: 0.9rem; color: #9a3412;">
                            ${isWanted ? 'If you spot this person, report immediately!' : 'Help locate this person and report any sighting.'}
                        </p>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="btn-report" onclick="reportAlertSighting('${id}', '${name}', '${image}', '${dbType}', ${priority}, ${isWanted})">
                            <i class="fas fa-broadcast-tower"></i> Report Sighting
                        </button>
                        <button class="btn-close-modal" onclick="hideModal()">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Report sighting from alert
function reportAlertSighting(personId, name, image, dbType, priority, isWanted) {
    // Store data for report
    lastMatchData = {
        person: {
            id: personId,
            name: name,
            image_filename: image,
            db_type: dbType,
            priority: priority,
            is_wanted: isWanted
        },
        confidence: 'Visual ID',
        capturedImage: null,  // No captured image for alert reports
        timestamp: new Date().toISOString(),
        fromAlert: true
    };
    
    showReportForm();
}
</script>
{% endblock %}
